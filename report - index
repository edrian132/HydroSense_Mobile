import { Ionicons } from "@expo/vector-icons";
import { useRouter } from "expo-router";
import React, { useContext, useEffect, useMemo, useState } from "react";
import {
  ActivityIndicator,
  Image,
  ImageBackground,
  StyleSheet,
  Text,
  TouchableOpacity,
  View,
} from "react-native";
import { SafeAreaView } from "react-native-safe-area-context";
import BottomNav from "../../../components/BottomNav";
import { ThemeContext } from "../../../context/themecontext";

export default function ReportsPage() {
  const router = useRouter();
  const { darkMode, toggleDarkMode } = useContext(ThemeContext);

  const theme = useMemo(
    () => ({
      background: darkMode ? "#121212" : "#f5f5f5",
      card: darkMode ? "#1e1e1e" : "#ffffff",
      text: darkMode ? "#ffffff" : "#000000",
      subText: darkMode ? "#bbbbbb" : "#333333",
      tableBackground: darkMode ? "#1e1e1e" : "#ffffff",
      header: "#8B0000", // maroon
    }),
    [darkMode]
  );

  const [reports, setReports] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // âœ… Fetch data from your API
  useEffect(() => {
    const fetchReports = async () => {
      try {
        const response = await fetch("https://your-api-url.com/api/reports"); // <-- change to your real API endpoint
        const data = await response.json();
        setReports(data);
      } catch (error) {
        console.error("Error fetching reports:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchReports();
  }, []);

  const getStatusStyle = (status: string) => {
    switch (status) {
      case "Optimal":
        return { backgroundColor: "#d4f8d4", borderColor: "green", textColor: "green" };
      case "Warning":
        return { backgroundColor: "#fff3cd", borderColor: "orange", textColor: "orange" };
      case "Critical":
        return { backgroundColor: "#f8d7da", borderColor: "red", textColor: "red" };
      default:
        return { backgroundColor: "#e0e0e0", borderColor: "gray", textColor: "gray" };
    }
  };

  const handleCardPress = (sensor: string) => {
    switch (sensor) {
      case "pH":
        router.push("/reports/phreports");
        break;
      case "Humidity":
        router.push("/reports/humidityreport");
        break;
      case "Temperature":
        router.push("/reports/tempreport");
        break;
      case "EC":
        router.push("/reports/ecreport");
        break;
    }
  };

  return (
    <SafeAreaView style={{ flex: 1, backgroundColor: theme.background }} edges={["top", "bottom"]}>
      <ImageBackground source={require("../../../assets/images/bg.png")} style={{ flex: 1 }}>
        {/* Header */}
        <View style={[styles.header, { backgroundColor: theme.header }]}>
          <View style={styles.headerLeft}>
            <Image source={require("../../../assets/images/logo.png")} style={styles.headerLogo} />
            <Text style={[styles.headerTitle, { color: "#fff" }]}>Reports</Text>
          </View>

          <View style={styles.headerRight}>
            <TouchableOpacity onPress={toggleDarkMode} style={styles.iconButton}>
              <Ionicons name={darkMode ? "moon" : "sunny"} size={22} color="#fff" />
            </TouchableOpacity>

            <TouchableOpacity onPress={() => router.push("/notifications")} style={styles.iconButton}>
              <Ionicons name="notifications" size={22} color="#fff" />
            </TouchableOpacity>
          </View>
        </View>

        {/* Main Content */}
        <View style={styles.mainContent}>
          {/* Sensor Cards */}
          <View style={styles.cardRow}>
            <TouchableOpacity style={[styles.card, { backgroundColor: theme.card }]} onPress={() => handleCardPress("pH")}>
              <Image source={require("../../../assets/images/ph.png")} style={styles.icon} />
              <Text style={[styles.cardLabel, { color: theme.text }]}>pH</Text>
            </TouchableOpacity>

            <TouchableOpacity style={[styles.card, { backgroundColor: theme.card }]} onPress={() => handleCardPress("Humidity")}>
              <Image source={require("../../../assets/images/humidity.png")} style={styles.icon} />
              <Text style={[styles.cardLabel, { color: theme.text }]}>Humidity</Text>
            </TouchableOpacity>
          </View>

          <View style={styles.cardRow}>
            <TouchableOpacity style={[styles.card, { backgroundColor: theme.card }]} onPress={() => handleCardPress("Temperature")}>
              <Image source={require("../../../assets/images/temperature.png")} style={styles.icon} />
              <Text style={[styles.cardLabel, { color: theme.text }]}>Temperature</Text>
            </TouchableOpacity>

            <TouchableOpacity style={[styles.card, { backgroundColor: theme.card }]} onPress={() => handleCardPress("EC")}>
              <Image source={require("../../../assets/images/ec.png")} style={styles.icon} />
              <Text style={[styles.cardLabel, { color: theme.text }]}>EC</Text>
            </TouchableOpacity>
          </View>

          {/* Recent Reports Table */}
          <View style={[styles.table, { backgroundColor: theme.tableBackground }]}>
            <Text style={[styles.tableTitle, { color: theme.text }]}>Recent Readings</Text>

            {loading ? (
              <ActivityIndicator size="small" color="#8B0000" style={{ marginTop: 10 }} />
            ) : (
              <>
                <View style={styles.tableRowHeader}>
                  <Text style={[styles.tableHeader, { flex: 3, color: theme.text }]}>Date/Time</Text>
                  <Text style={[styles.tableHeader, { flex: 1, color: theme.text }]}>Sensor</Text>
                  <Text style={[styles.tableHeader, { flex: 1, color: theme.text }]}>Value</Text>
                  <Text style={[styles.tableHeader, { flex: 1, color: theme.text }]}>Status</Text>
                </View>

                {reports.length === 0 ? (
                  <Text style={{ textAlign: "center", color: theme.subText, marginVertical: 10 }}>
                    No data available
                  </Text>
                ) : (
                  reports.map((r, i) => {
                    const statusStyle = getStatusStyle(r.status);
                    return (
                      <View style={styles.tableRow} key={i}>
                        <Text style={[styles.tableCell, { flex: 3, color: theme.subText }]}>{r.datetime}</Text>
                        <Text style={[styles.tableCell, { flex: 1, color: theme.subText }]}>{r.sensor}</Text>
                        <Text style={[styles.tableCell, { flex: 1, color: theme.subText }]}>{r.value}</Text>
                        <View
                          style={[
                            styles.badge,
                            {
                              backgroundColor: statusStyle.backgroundColor,
                              borderColor: statusStyle.borderColor,
                            },
                          ]}
                        >
                          <Text style={[styles.badgeText, { color: statusStyle.textColor }]}>{r.status}</Text>
                        </View>
                      </View>
                    );
                  })
                )}
              </>
            )}
          </View>
        </View>

        <BottomNav activeTab="reports" />
      </ImageBackground>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  header: { flexDirection: "row", alignItems: "center", justifyContent: "space-between", paddingVertical: 12, paddingHorizontal: 18 },
  headerLeft: { flexDirection: "row", alignItems: "center" },
  headerRight: { flexDirection: "row", alignItems: "center" },
  iconButton: { marginLeft: 12 },
  headerLogo: { width: 40, height: 40, marginRight: 12, resizeMode: "contain" },
  headerTitle: { fontSize: 20, fontWeight: "700" },
  mainContent: { padding: 12, flex: 1 },
  cardRow: { flexDirection: "row", justifyContent: "space-between", marginBottom: 20 },
  card: {
    flex: 1,
    marginHorizontal: 6,
    borderRadius: 18,
    paddingVertical: 26,
    paddingHorizontal: 18,
    alignItems: "center",
    shadowColor: "#000",
    shadowOpacity: 0.15,
    shadowOffset: { width: 0, height: 3 },
    shadowRadius: 6,
    elevation: 4,
  },
  icon: { width: 65, height: 65, marginBottom: 12, resizeMode: "contain" },
  cardLabel: { fontSize: 15, fontWeight: "600" },
  table: {
    borderRadius: 12,
    padding: 10,
    marginTop: 10,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowOffset: { width: 0, height: 2 },
    shadowRadius: 4,
    elevation: 3,
  },
  tableTitle: { fontSize: 13, fontWeight: "700", marginBottom: 6, textAlign: "center" },
  tableRowHeader: { flexDirection: "row", justifyContent: "space-between", paddingVertical: 5, borderBottomWidth: 1, borderColor: "#666" },
  tableRow: { flexDirection: "row", alignItems: "center", justifyContent: "space-between", paddingVertical: 4, borderBottomWidth: 1, borderColor: "#444" },
  tableHeader: { fontSize: 11, fontWeight: "700", textAlign: "center" },
  tableCell: { fontSize: 10, textAlign: "center" },
  badge: { flex: 1, paddingVertical: 2, paddingHorizontal: 6, borderRadius: 6, alignItems: "center", borderWidth: 1.5 },
  badgeText: { fontSize: 10, fontWeight: "700" },
});

