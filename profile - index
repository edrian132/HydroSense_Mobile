import { Ionicons } from "@expo/vector-icons";
import AsyncStorage from "@react-native-async-storage/async-storage";
import { useRouter } from "expo-router";
import React, { useContext, useEffect, useMemo, useState } from "react";
import {
  Image,
  ScrollView,
  StyleSheet,
  Text,
  TouchableOpacity,
  View,
} from "react-native";
import { SafeAreaView } from "react-native-safe-area-context";
import BottomNav from "../../../components/BottomNav";
import { ThemeContext } from "../../../context/themecontext";

// âœ… Assets
import logo from "../../../assets/images/logo.png";
import picture from "../../../assets/images/picture.png";

export default function ProfilePage() {
  const { darkMode } = useContext(ThemeContext);
  const router = useRouter();

  const [userData, setUserData] = useState({
    name: "",
    email: "",
    department: "",
    yearLevel: "",
    studentId: "",
    profileImage: picture,
  });

  const theme = useMemo(
    () => ({
      background: darkMode ? "#121212" : "#f2f2f2",
      card: darkMode ? "#1e1e1e" : "#fff",
      text: darkMode ? "#fff" : "#000",
      subText: darkMode ? "#bbb" : "#555",
      label: darkMode ? "#ccc" : "#333",
      avatarBorder: darkMode ? "#444" : "#fff",
      header: darkMode ? "#1e1e1e" : "#f2f2f2",
      buttonBackground: darkMode ? "#8b0000" : "#a82020",
    }),
    [darkMode]
  );

  useEffect(() => {
    const fetchUserData = async () => {
      try {
        const storedUser = await AsyncStorage.getItem("userData");
        if (storedUser) setUserData(JSON.parse(storedUser));
      } catch (error) {
        console.error("Failed to load user data:", error);
      }
    };
    fetchUserData();
  }, []);

  const handleLogout = async () => {
    try {
      await AsyncStorage.removeItem("isLoggedIn");
      await AsyncStorage.removeItem("rememberEmail");
      await AsyncStorage.removeItem("userData");
      router.replace("/login");
    } catch (error) {
      console.error("Logout failed:", error);
    }
  };

  return (
    <SafeAreaView
      edges={["top", "left", "right"]}
      style={[styles.container, { backgroundColor: theme.background }]}
    >
      {/* Header */}
      <View style={[styles.headerContainer, { backgroundColor: "#8B0000" }]}>
        <Image source={logo} style={styles.logo} />
        <Text style={styles.appName}>Profile</Text>
      </View>

      <ScrollView contentContainerStyle={styles.scrollArea}>
        <View style={[styles.card, { backgroundColor: theme.card }]}>
          {/* Profile Section */}
          <View style={[styles.header, { backgroundColor: theme.header }]}>
            <View
              style={[
                styles.avatarContainer,
                { borderColor: theme.avatarBorder, backgroundColor: "#8b0000" },
              ]}
            >
              <Image source={userData.profileImage} style={styles.avatar} />
            </View>

            {/* Name, Email, Student ID under profile picture */}
            <View style={styles.profileInfo}>
              <Text style={[styles.name, { color: theme.text }]}>
                {userData.name || ""}
              </Text>
              <Text style={[styles.email, { color: theme.subText }]}>
                {userData.email || ""}
              </Text>
              <Text style={[styles.studentId, { color: theme.subText }]}>
                {userData.studentId ? `ID: ${userData.studentId}` : ""}
              </Text>
            </View>
          </View>

          {/* Details */}
          <View style={styles.details}>
            <View style={styles.row}>
              <Ionicons name="school" size={16} color={theme.subText} />
              <Text style={[styles.label, { color: theme.label }]}> Department:</Text>
              <Text style={[styles.value, { color: theme.text }]}>
                {userData.department || ""}
              </Text>
            </View>

            <View style={styles.row}>
              <Ionicons name="ribbon" size={16} color={theme.subText} />
              <Text style={[styles.label, { color: theme.label }]}> Year Level:</Text>
              <Text style={[styles.value, { color: theme.text }]}>
                {userData.yearLevel || ""}
              </Text>
            </View>
          </View>

          {/* Activity Logs */}
          <View style={styles.logsContainer}>
            <Text style={[styles.sectionTitle, { color: theme.text }]}>
              Activity Logs
            </Text>

            <View style={styles.logItem}>
              <Ionicons name="log-in-outline" size={16} color={theme.subText} />
              <Text style={[styles.logText, { color: theme.text }]}>
                Logged In
              </Text>
            </View>

            <View style={styles.logItem}>
              <Ionicons name="eye-outline" size={16} color={theme.subText} />
              <Text style={[styles.logText, { color: theme.text }]}>
                Recently Viewed
              </Text>
            </View>

            <View style={styles.logItem}>
              <Ionicons
                name="notifications-outline"
                size={16}
                color={theme.subText}
              />
              <Text style={[styles.logText, { color: theme.text }]}>
                Checked Notifications
              </Text>
            </View>

            {/* Logout */}
            <TouchableOpacity
              style={[
                styles.logoutButton,
                { backgroundColor: theme.buttonBackground },
              ]}
              onPress={handleLogout}
            >
              <Ionicons name="log-out-outline" size={16} color="#fff" />
              <Text style={styles.logoutText}>Logout</Text>
            </TouchableOpacity>
          </View>
        </View>
      </ScrollView>

      <SafeAreaView edges={["bottom"]} style={{ backgroundColor: theme.card }}>
        <BottomNav active="profile" />
      </SafeAreaView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  headerContainer: {
    flexDirection: "row",
    alignItems: "center",
    padding: 15,
  },
  logo: { width: 30, height: 30, marginRight: 10 },
  appName: { color: "white", fontSize: 18, fontWeight: "bold" },

  scrollArea: {
    alignItems: "center",
    paddingBottom: 80,
  },

  card: {
    width: "90%",
    borderRadius: 15,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 6,
    elevation: 4,
    overflow: "hidden",
    marginTop: 12,
    marginBottom: 8,
  },

  header: {
    alignItems: "center",
    paddingVertical: 25,
    borderBottomLeftRadius: 15,
    borderBottomRightRadius: 15,
  },
  avatarContainer: {
    width: 90,
    height: 90,
    borderRadius: 45,
    alignItems: "center",
    justifyContent: "center",
    overflow: "hidden",
    marginBottom: 12,
    borderWidth: 2,
  },
  avatar: { width: "100%", height: "100%", resizeMode: "cover" },

  profileInfo: { alignItems: "center", marginTop: 8 },
  name: { fontSize: 18, fontWeight: "bold", marginBottom: 2 },
  email: { fontSize: 13, marginBottom: 2 },
  studentId: { fontSize: 13 },

  details: { padding: 15, paddingBottom: 8 },
  row: { flexDirection: "row", alignItems: "center", marginBottom: 10 },
  label: { fontWeight: "bold", fontSize: 13 },
  value: { fontSize: 13 },

  logsContainer: {
    padding: 15,
  },
  sectionTitle: { fontSize: 14, fontWeight: "bold", marginBottom: 10 },
  logItem: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 8,
  },
  logText: {
    marginLeft: 8,
    fontSize: 13,
  },

  logoutButton: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "center",
    paddingVertical: 12,
    borderRadius: 8,
    marginTop: 18,
  },
  logoutText: {
    color: "#fff",
    fontWeight: "bold",
    marginLeft: 6,
    fontSize: 14,
  },
});
